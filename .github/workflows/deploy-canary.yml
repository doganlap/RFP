name: Deploy Canary

on:
  workflow_dispatch:
    inputs:
      environment:
        description: Target environment
        required: true
        type: choice
        options:
          - staging
          - prod

permissions:
  contents: read

jobs:
  build-and-push:
    if: ${{ hashFiles('Dockerfile') != '' }}
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.meta.outputs.image }}
    steps:
      - uses: actions/checkout@v4
      - name: Login to GHCR
        run: echo "${{ secrets.CR_PAT }}" | docker login ghcr.io -u "${{ github.repository_owner }}" --password-stdin
      - id: meta
        name: Set image name
        run: echo "image=ghcr.io/${{ github.repository_owner }}/rfp-app:${{ github.sha }}" >> $GITHUB_OUTPUT
      - name: Build
        run: docker build -t ${{ steps.meta.outputs.image }} .
      - name: Push
        run: docker push ${{ steps.meta.outputs.image }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    env:
      IMAGE: ${{ needs.build-and-push.outputs.image }}
    steps:
      - uses: actions/checkout@v4
      - name: Install kubectl
        run: |
          curl -sLO https://storage.googleapis.com/kubernetes-release/release/v1.29.0/bin/linux/amd64/kubectl
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/kubectl
      - name: Install argo rollouts plugin
        run: |
          curl -sL -o kubectl-argo-rollouts https://github.com/argoproj/argo-rollouts/releases/download/v1.6.2/kubectl-argo-rollouts-linux-amd64
          chmod +x kubectl-argo-rollouts
          sudo mv kubectl-argo-rollouts /usr/local/bin/kubectl-argo-rollouts
      - name: Configure kubecontext
        run: |
          if [ "${{ inputs.environment }}" = "staging" ]; then
            echo "${{ secrets.KUBE_CONFIG_STAGING }}" > $HOME/kubeconfig
            NS=rfp-staging
            DIR=deploy/k8s/staging
          else
            echo "${{ secrets.KUBE_CONFIG_PROD }}" > $HOME/kubeconfig
            NS=rfp-prod
            DIR=deploy/k8s/prod
          fi
          echo "NS=$NS" >> $GITHUB_ENV
          echo "DIR=$DIR" >> $GITHUB_ENV
      - name: Apply namespace and analysis templates
        env:
          KUBECONFIG: ${{ env.HOME }}/kubeconfig
        run: |
          kubectl apply -f $DIR/namespace.yaml
          kubectl -n $NS apply -f deploy/k8s/analysis-template.yaml
      - name: Apply service and rollout
        env:
          KUBECONFIG: ${{ env.HOME }}/kubeconfig
        run: |
          kubectl -n $NS apply -f $DIR/service.yaml
          kubectl -n $NS apply -f $DIR/rollout.yaml
      - name: Update image
        env:
          KUBECONFIG: ${{ env.HOME }}/kubeconfig
        run: |
          kubectl -n $NS argo rollouts set image rollout/rfp-app app-container=$IMAGE
      - name: Watch rollout
        env:
          KUBECONFIG: ${{ env.HOME }}/kubeconfig
        run: |
          kubectl-argo-rollouts -n $NS status rfp-app --watch
      - name: Promote if healthy
        env:
          KUBECONFIG: ${{ env.HOME }}/kubeconfig
        run: |
          kubectl-argo-rollouts -n $NS promote rfp-app