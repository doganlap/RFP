name: CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  node:
    name: Node.js Validation
    if: ${{ hashFiles('package.json') != '' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
      - name: Install dependencies
        run: |
          if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then
            npm ci
          else
            npm install --no-audit --no-fund
          fi
      - name: Lint
        run: npm run lint --if-present
      - name: Type check
        run: npm run typecheck --if-present
      - name: Test with coverage
        run: |
          npm test -- --coverage --watchAll=false --ci || echo "Tests command not present"
      - name: Coverage gate (≥80%)
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            node -e "const s=require('./coverage/coverage-summary.json'); const p=s.total.lines.pct; if(p<80){console.error('Coverage lines '+p+'% < 80%'); process.exit(1);} else console.log('Coverage OK '+p+'%');"
          else
            echo "No coverage summary found; skipping gate"
          fi

  python:
    name: Python Validation
    if: ${{ hashFiles('pyproject.toml') != '' || hashFiles('requirements.txt') != '' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dev tools
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov flake8 mypy
      - name: Install project dependencies (if requirements.txt)
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
      - name: Lint
        run: flake8 .
      - name: Type check
        run: mypy --ignore-missing-imports .
      - name: Tests with coverage
        run: pytest --maxfail=1 --disable-warnings -q --cov=. --cov-report=xml
      - name: Coverage gate (≥80%)
        run: |
          python - <<'PY'
          import xml.etree.ElementTree as ET
          import sys
          try:
              root = ET.parse('coverage.xml').getroot()
              rate = float(root.get('line-rate'))*100
              print(f'Coverage {rate:.2f}%')
              sys.exit(0 if rate >= 80 else 1)
          except Exception as e:
              print('No coverage.xml found or parse error:', e)
          PY

  go:
    name: Go Validation
    if: ${{ hashFiles('go.mod') != '' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '>=1.21'
      - name: Vet
        run: go vet ./...
      - name: Tests with coverage
        run: |
          go test ./... -coverprofile=coverage.out
          go tool cover -func=coverage.out | tail -n 1 | awk '{print $3}' | sed 's/%//' > coverage_pct.txt
      - name: Coverage gate (≥80%)
        run: |
          pct=$(cat coverage_pct.txt || echo 0)
          echo "Coverage ${pct}%"
          awk -v p="$pct" 'BEGIN{exit (p>=80)?0:1}'

  docker:
    name: Docker Validation
    if: ${{ hashFiles('Dockerfile') != '' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Lint Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile

  terraform:
    name: Terraform Validation
    if: ${{ hashFiles('**/*.tf') != '' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
      - name: Terraform fmt
        run: terraform fmt -check
      - name: Terraform init
        run: terraform init -backend=false
      - name: Terraform validate
        run: terraform validate
      - name: Setup tflint
        uses: terraform-linters/setup-tflint@v5
      - name: Run tflint
        run: |
          tflint --init
          tflint -f compact